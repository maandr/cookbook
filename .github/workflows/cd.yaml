name: CD
on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.editorconfig'
      - '.gitignore'
      - '.npmrc'
      - '.eslintrc.cjs'
      - '.eslintignore'
      - '.prettier.config.cjs'
      - '.vscode/**'
jobs:
  build-publish-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        id: checkout-repository
        uses: actions/checkout@master

      - name: Build and Publish Docker Image
        id: build-docker-image
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          registry: docker.pkg.github.com
          name: ${{ github.repository }}/cookbook
          username: ${{ github.actor }}
          password: ${{ github.token }}
          tags: 'latest'

      - name: Deploy to Remote Host
        id: deploy
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            docker login -u ${{ github.actor }} -p ${{ github.token }} docker.pkg.github.com
            docker pull docker.pkg.github.com/${{ github.repository }}/cookbook:latest
            docker rm -f cookbook
            docker run --detach --name cookbook --rm --network=infra-network --env VIRTUAL_HOST=cookbook.maandr.de --env LETSENCRYPT_HOST=cookbook.maandr.de docker.pkg.github.com/${{ github.repository }}/cookbook:latest
            docker image prune -f
  smoke-test:
    runs-on: ubuntu-latest
    needs: build-publish-and-deploy
    steps:
      - name: smoke-test for cookbook.maandr.de
        id: smoke-test
        uses: wei/curl@master
        with:
          args: https://cookbook.maandr.de
